<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SWIL</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Arial, sans-serif; background:url('https://i.pinimg.com/736x/68/aa/c8/68aac8479ce6bd16304fda727f9c2486.jpg') center/cover fixed; color:#000; min-height:100vh;}
  h1{font-size:4rem;text-align:center;margin-top:120px;-webkit-text-stroke:2px red;color:black}
  h2{text-align:center;margin-bottom:30px;-webkit-text-stroke:1px red}
  #login-section,#post-section{width:90%;max-width:820px;margin:14px auto;background:rgba(255,255,255,0.88);padding:14px;border-radius:10px}
  #posts{width:90%;max-width:820px;margin:12px auto 120px auto}
  .post,.comment{background:rgba(255,255,255,0.95);padding:10px;border-radius:8px;margin:10px 0}
  .post small{display:block;color:#666;margin-top:6px;font-size:0.85rem}
  .comment .admin-header{font-weight:bold;color:black;text-shadow: 2px 0 red,-2px 0 red,0 2px red,0 -2px red}
  textarea{width:100%;min-height:60px;padding:8px;border-radius:6px;border:1px solid #ccc}
  input[type=file]{width:100%}
  button{padding:6px 10px;border-radius:6px;border:0;background:#222;color:#fff;cursor:pointer}
  #debug{position:fixed;right:10px;bottom:10px;max-width:420px;background:rgba(0,0,0,0.75);color:#fff;padding:8px;border-radius:8px;z-index:9999;font-size:0.85rem;overflow:auto;max-height:220px}
  .debug-error{color:#ff9b9b}
  .static-fallback{width:90%;max-width:820px;margin:12px auto}
</style>
</head>
<body>

<h1>SWIL</h1>
<h2>Sharing - What - I - Like</h2>

<!-- LOGIN -->
<div id="login-section">
  <label for="role-select">Select Role:</label>
  <select id="role-select" onchange="togglePasswordField()">
    <option value="guest">Guest</option>
    <option value="admin">Admin</option>
  </select>

  <div id="password-div" style="display:none;margin-top:8px;">
    <input id="admin-password" type="password" placeholder="Admin password">
  </div>

  <div style="margin-top:8px;">
    <button onclick="login()">Login</button>
    <span id="role-status" style="margin-left:12px;font-weight:600">Role: guest</span>
  </div>
</div>

<!-- ADMIN POST SECTION -->
<div id="post-section" style="display:none">
  <h3>Create a Post</h3>
  <textarea id="post-text" placeholder="Write something..."></textarea>
  <div style="margin-top:8px;"><input id="post-file" type="file" accept="image/*,video/*,gif"></div>
  <div style="margin-top:8px"><button onclick="createPost()">Post</button></div>
</div>

<!-- Static fallback posts (visible if DB fails) -->
<div id="static-fallback" class="static-fallback">
  <div class="post"><p><strong>[Admin]</strong> Welcome â€” static fallback post (replace or remove when DB works).</p><small>Fallback: visible when DB unreadable</small></div>
</div>

<!-- POSTS -->
<div id="posts"></div>

<!-- Debug box -->
<div id="debug" aria-live="polite"></div>

<!-- Firebase compat libraries (non-module, provide global `firebase`) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

<script>
/* ---------- CONFIG: set your Firebase config here ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyAzZWzC7n-XKAdlCLrGM3TPDl9Uo5rUKzY",
  authDomain: "swil-eb81a.firebaseapp.com",
  databaseURL: "https://swil-eb81a-default-rtdb.firebaseio.com",
  projectId: "swil-eb81a",
  storageBucket: "swil-eb81a.appspot.com",
  messagingSenderId: "964324457027",
  appId: "1:964324457027:web:9c1e7f6331a8c59b52f2f6"
};
/* ---------------------------------------------------------- */

function logDebug(msg, isError = false) {
  const d = document.getElementById('debug');
  const el = document.createElement('div');
  if (isError) el.className = 'debug-error';
  el.textContent = `${new Date().toLocaleTimeString()} â€” ${msg}`;
  d.prepend(el);
  console[isError ? 'error' : 'log'](msg);
}

try {
  firebase.initializeApp(firebaseConfig);
} catch(e) {
  logDebug('Firebase init failed: ' + e.message, true);
}

const db = firebase.database();
const storage = firebase.storage();

let role = 'guest';

/* Expose UI functions globally so HTML attributes work */
window.togglePasswordField = function(){
  try {
    const sel = document.getElementById('role-select').value;
    document.getElementById('password-div').style.display = sel === 'admin' ? 'block' : 'none';
  } catch(e) { logDebug('togglePasswordField error: '+e.message, true); }
};

window.login = function() {
  try {
    const sel = document.getElementById('role-select').value;
    const pass = document.getElementById('admin-password').value || '';
    if (sel === 'admin' && pass === 'didifuckingstutter') {
      role = 'admin';
      document.getElementById('post-section').style.display = 'block';
      logDebug('Logged in as admin');
      alert('âœ… Logged in as Admin');
    } else {
      role = 'guest';
      document.getElementById('post-section').style.display = 'none';
      logDebug('Logged in as guest');
      alert('ðŸ‘¤ Logged in as Guest');
    }
    document.getElementById('role-status').innerText = 'Role: ' + role;
  } catch(e) { logDebug('Login error: ' + e.message, true); }
};
window.login = window.login; // ensure global

// create post (admin only)
window.createPost = async function() {
  try {
    if (role !== 'admin') { alert('Only admin can create posts'); return; }
    const text = (document.getElementById('post-text').value || '').trim();
    const fileInput = document.getElementById('post-file');
    let fileURL = null;

    if (!text && fileInput.files.length === 0) {
      alert('Type text or choose a file to post');
      return;
    }

    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      // unique filename to reduce collisions
      const uniqueName = Date.now() + '_' + Math.random().toString(36).slice(2,8) + '_' + file.name;
      const storageRef = storage.ref('uploads/' + uniqueName);
      logDebug('Uploading file to storage...');
      const uploadTask = await storageRef.put(file);
      fileURL = await uploadTask.ref.getDownloadURL();
      logDebug('File uploaded: ' + fileURL);
    }

    const pushRef = db.ref('posts').push();
    await pushRef.set({
      text: text || '',
      fileURL: fileURL || null,
      role: role,
      timestamp: new Date().toLocaleString()
    });
    document.getElementById('post-text').value = '';
    fileInput.value = '';
    alert('Post created âœ…');
  } catch(err) {
    logDebug('createPost error: ' + (err && err.message ? err.message : err), true);
    alert('Failed to create post â€” see debug box or console.');
  }
};

// Add comment helper
async function addComment(postId, commentText) {
  try {
    if (!commentText) return;
    const commentRef = db.ref('posts/' + postId + '/comments').push();
    await commentRef.set({ text: commentText, role: role, timestamp: new Date().toLocaleString() });
  } catch(err) {
    logDebug('addComment error: ' + (err && err.message ? err.message : err), true);
    alert('Failed to add comment â€” check debug box.');
  }
}

// Listen & render posts
function startListening() {
  try {
    const postsDiv = document.getElementById('posts');
    const fallback = document.getElementById('static-fallback');
    const postsRef = db.ref('posts');

    postsRef.on('value', snapshot => {
      try {
        const val = snapshot.val();
        postsDiv.innerHTML = '';
        if (!val) {
          // no DB posts â€” show fallback
          fallback.style.display = 'block';
          logDebug('No posts in DB (showing fallback).');
          return;
        }
        fallback.style.display = 'none';
        // render posts newest first
        Object.keys(val).reverse().forEach(postId => {
          const p = val[postId];
          const postDiv = document.createElement('div');
          postDiv.className = 'post';

          // build inner html safely (simple escaping)
          function esc(s){ return (s===null||s===undefined) ? '' : String(s); }

          let html = `<p>${p.role === 'admin' ? "<strong style='color:red'>[Admin]</strong> " : ""}${esc(p.text || '')}</p>`;
          if (p.fileURL) html += `<div style="margin-top:8px;"><img src="${p.fileURL}" style="max-width:100%;border-radius:6px" alt="uploaded"></div>`;
          html += `<small>Posted at: ${esc(p.timestamp)}</small>`;
          html += `<div class="comments" style="margin-top:8px"></div>`;
          html += `<textarea placeholder="Add a comment"></textarea>`;
          html += `<div style="margin-top:6px"><button class="comment-btn">Comment</button></div>`;

          postDiv.innerHTML = html;
          postsDiv.appendChild(postDiv);

          // comments listener
          const commentsDiv = postDiv.querySelector('.comments');
          const commentsRef = db.ref('posts/' + postId + '/comments');
          commentsRef.on('value', snap => {
            commentsDiv.innerHTML = '';
            const cs = snap.val();
            if (!cs) return;
            Object.keys(cs).forEach(cid => {
              const c = cs[cid];
              const cDiv = document.createElement('div');
              cDiv.className = 'comment';
              if (c.role === 'admin') {
                const header = document.createElement('div');
                header.className = 'admin-header';
                header.innerText = 'Admin';
                cDiv.appendChild(header);
              }
              const t = document.createElement('div');
              t.innerText = c.text;
              cDiv.appendChild(t);
              commentsDiv.appendChild(cDiv);
            });
          }, err => {
            logDebug('Comments read error for post ' + postId + ': '+err.message, true);
          });

          // comment button handler (visible to both admin & guest)
          postDiv.querySelector('.comment-btn').addEventListener('click', () => {
            const ta = postDiv.querySelector('textarea');
            const text = (ta.value||'').trim();
            if (!text) { alert('Comment cannot be empty'); return; }
            addComment(postId, text);
            ta.value = '';
          });
        });
      } catch(innerErr){
        logDebug('render posts error: ' + innerErr.message, true);
      }
    }, err => {
      logDebug('DB read failed: ' + (err && err.message ? err.message : err), true);
      // keep fallback visible
      document.getElementById('static-fallback').style.display = 'block';
    });
  } catch(e) {
    logDebug('startListening error: ' + e.message, true);
  }
}

// init once DOM loaded
window.addEventListener('DOMContentLoaded', () => {
  try {
    // UI initial state
    document.getElementById('post-section').style.display = 'none';
    document.getElementById('password-div').style.display = 'none';
    document.getElementById('role-status').innerText = 'Role: guest';
    // ensure onchange works even if user tabs to select
    document.getElementById('role-select').addEventListener('change', window.togglePasswordField);
    // start DB listeners
    startListening();
    logDebug('App initialized. Listening for posts...');
  } catch(e) {
    logDebug('init error: ' + e.message, true);
  }
});
</script>
</body>
</html>
